<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>画像比率調整ツール</title>
<style>
body {
    font-family: 'Helvetica Neue', Arial, sans-serif;
    max-width: 960px;
    margin: 0 auto;
    padding: 20px;
    background-color: #f5f5f5;
    color: #333;
    line-height: 1.6;
}

h1 {
    color: #2c3e50;
    text-align: center;
    margin-bottom: 30px;
}

/* ドラッグ＆ドロップ領域 */
.drop-area {
    border: 3px dashed #3498db;
    border-radius: 8px;
    padding: 40px 20px;
    text-align: center;
    background-color: #ecf0f1;
    cursor: pointer;
    transition: all .3s;
    margin-bottom: 30px;
}

.drop-area:hover, .drop-area.active {
    background-color: #d6eaf8;
    border-color: #2980b9;
}

.drop-area p {
    margin: 10px 0;
    color: #555;
}

.drop-area button {
    margin-top: 15px;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #3498db;
    color: #fff;
    font-size: 1em;
    transition: background-color .3s ease;
}

.drop-area button:hover {
    background-color: #2980b9;
}


.main-content-container {
    margin-top: 0;
    display: flex; /* Flexboxに */
    flex-direction: column; /* 縦並び（モバイル優先） */
    gap: 30px; /* 各セクション間の隙間 */
}

/* オリジナル画像プレビューと調整済み画像プレビューのコンテナ */
.image-preview-container {
    display: flex;
    flex-direction: column; /* 縦並び */
    gap: 30px; /* プレビュー間の隙間 */
}


/* オリジナル画像プレビュー */
.image-preview {
    margin-top: 0;
    text-align: center;
    display: none; /* 初期非表示 */
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
}

.image-preview h2 {
    margin-top: 0;
    color: #2c3e50;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.image-preview img {
    max-width: 100%;
    max-height: 400px;
    height: auto;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
}

.controls-area {
    display: flex;
    flex-direction: column;
    gap: 20px; /* 情報パネルと調整オプションの間の隙間 */
}

/* 情報パネル */
.info-panel {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    display: none; /* 初期非表示 */
}

.info-panel h2 {
    color: #2c3e50;
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

.info-grid {
    display: grid;
    grid-template-columns: 1fr; /* モバイルは1カラム */
    gap: 20px;
    margin-bottom: 0;
}

.info-panel .info-item {
    margin-bottom: 15px;
}
.info-panel .info-item:last-child {
    margin-bottom: 0;
}


.ratio-description {
    font-size: .9em;
    color: #7f8c8d;
    margin-top: 5px;
    margin-bottom: 0;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    font-size: .9em;
}

table th, table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

table th {
    background-color: #f8f8f8;
    font-weight: bold;
    color: #555;
}

table td .unit-display {
    display: block;
    font-size: .85em;
    color: #7f8c8d;
    margin-top: 4px;
    line-height: 1.4;
}

table td .unit-display span {
    margin-right: 8px;
}

.current-ratio {
    font-size: 1.2em;
    font-weight: bold;
    color: #e74c3c;
}

/* 調整オプション */
.adjustment-options {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    display: none; /* 初期非表示 */
}

.adjustment-options h2 {
    color: #2c3e50;
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

#scaleControl, #colorPickerControl {
    padding: 15px;
    background-color: #ecf0f1;
    border-radius: 8px;
    margin-bottom: 20px;
}

#scaleControl label, #colorPickerControl label {
    margin-right: 10px;
    font-weight: bold;
    color: #555;
}

#scaleControl input[type="number"] {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    width: 80px;
    text-align: center;
}

#colorPickerControl input[type="color"] {
    vertical-align: middle;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 2px;
}

/* 比率選択セレクトボックス */
.ratio-select-container {
    margin-bottom: 20px;
}
.ratio-select-container label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #555;
}
.ratio-select-container select {
    width: 100%;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1em;
    box-sizing: border-box;
}

/* 選択された比率の詳細表示エリア */
#selectedRatioDetails {
    margin-top: 20px; /* セレクトボックスとの間に余白 */
    padding-top: 20px;
    border-top: 1px solid #eee; /* 区切り線 */
}

#selectedRatioDetails h3 { /* 比率名 */
    margin-top: 0;
    color: #34495e;
    margin-bottom: 5px;
    font-size: 1.1em;
}

#selectedRatioDetails .ratio-description { /* 比率説明文 */
    margin-bottom: 15px;
}

.adjustment-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #ddd;
}

.adjustment-details:first-child {
    border-top: none;
    padding-top: 0;
    margin-top: 0;
}

.adjustment-details h4 {
    margin-top: 0;
    margin-bottom: 8px;
    color: #555;
    font-size: 1em;
}

.adjustment-details table {
    margin-bottom: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    overflow: hidden;
}

.adjustment-details table th, .adjustment-details table td {
    border-bottom: 1px solid #eee;
}
.adjustment-details table tr:last-child td {
    border-bottom: none;
}


.adjustment-details button {
    margin-right: 10px;
    padding: 8px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #3498db;
    color: #fff;
    transition: background-color .3s ease;
    font-size: 0.95em;
}

.adjustment-details button:last-child {
    margin-right: 0;
}

.adjustment-details button:hover:not(:disabled) {
    background-color: #2980b9;
}
.adjustment-details button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}


/* 調整済み画像プレビュー */
.adjusted-image-area {
    margin-top: 0; /* image-preview-container の gap で調整 */
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,.1);
    display: none; /* 初期非表示 */
}

.adjusted-image-area h2 {
    color: #2c3e50;
    margin-top: 0;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
    margin-bottom: 15px;
}

#adjustedCanvas {
    max-width: 100%;
    height: auto;
    border: 1px solid #ddd;
    box-shadow: 0 2px 5px rgba/0,0,0,.1);
    margin-bottom: 20px;
    display: block;
    margin-left: auto;
    margin-right: auto;
}

.adjusted-image-actions {
    text-align: center;
    margin-top: 10px;
    margin-bottom: 15px;
}

.adjusted-image-actions button {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    background-color: #2ecc71;
    color: #fff;
    margin: 0 10px;
    transition: background-color .3s ease;
    font-size: 1em;
}

.adjusted-image-actions button:hover {
    background-color: #27ae60;
}

.adjusted-image-area p small {
    display: block;
    text-align: center;
    color: #7f8c8d;
    font-size: 0.85em;
}


/* レスポンシブデザイン */
@media (min-width: 768px) {
    .main-content-container {
        display: grid;
        grid-template-columns: minmax(350px, 1.5fr) minmax(300px, 1fr); /* 左：プレビュー群、右：操作系 */
        align-items: start; /* 上揃え */
    }

    /* 左カラムにはプレビューコンテナ全体を配置 */
    .image-preview-container {
        grid-column: 1; /* 左カラム */
        display: flex;
        flex-direction: column;
        gap: 30px; /* プレビュー間の隙間 */
    }

     /* 個別のプレビューは Flexbox で中身を中央寄せなど調整 */
    .image-preview, .adjusted-image-area {
         display: flex;
         flex-direction: column; /* タイトルと画像を縦並びに */
         justify-content: flex-start; /* 上揃え */
         align-items: center; /* 中央揃え */
         padding: 20px; /* PCサイズもパディング維持 */
    }
    .image-preview img, #adjustedCanvas {
        margin-top: 0; /* flex-direction: column にしたので */
    }


    .controls-area {
        grid-column: 2; /* 右カラム */
        margin-top: 0; /* グリッドのgapで調整 */
    }

    .info-grid {
        grid-template-columns: 1fr; /* 2カラム */
    }

    .info-panel .info-item {
        margin-bottom: 0; /* グリッドのgapで調整 */
    }

    .adjustment-details button {
        display: inline-block;
        width: auto;
        margin-bottom: 0;
    }

     .adjusted-image-actions button {
        display: inline-block;
        width: auto;
        margin: 0 10px;
    }
}

@media (max-width: 767px) {
    body {
        padding: 15px;
    }

    h1 {
        margin-bottom: 20px;
    }

    .drop-area {
        padding: 30px 15px;
        margin-bottom: 20px;
    }
    .drop-area p {
        margin: 5px 0;
    }
     .drop-area button {
        margin-top: 10px;
        padding: 8px 15px;
    }

    .main-content-container {
        gap: 20px;
    }

    .image-preview-container {
        gap: 20px; /* モバイルでのプレビュー間の隙間 */
    }

    .image-preview, .adjusted-image-area {
        padding: 15px;
    }
     .image-preview h2, .adjusted-image-area h2 {
        margin-bottom: 10px;
        padding-bottom: 8px;
     }

    .controls-area {
        gap: 15px;
    }

    .info-panel, .adjustment-options {
        padding: 15px;
    }
    .info-panel h2, .adjustment-options h2 {
        margin-bottom: 10px;
        padding-bottom: 8px;
    }

    .info-grid {
        grid-template-columns: 1fr;
        gap: 10px;
    }

    table td .unit-display {
        margin-top: 2px;
        font-size: 0.8em;
    }

    .ratio-select-container {
        margin-bottom: 15px;
    }
     .ratio-select-container label {
         margin-bottom: 5px;
         font-size: 0.95em;
     }
    .ratio-select-container select {
         padding: 6px;
         font-size: 0.95em;
    }

    #selectedRatioDetails {
        margin-top: 15px;
        padding-top: 15px;
    }
     #selectedRatioDetails h3 {
         font-size: 1em;
     }
     #selectedRatioDetails .ratio-description {
         margin-bottom: 10px;
     }


    .adjustment-details {
        margin-top: 10px;
        padding-top: 10px;
    }
    .adjustment-details h4 {
        font-size: 0.95em;
        margin-bottom: 5px;
    }

    .adjustment-details table {
         margin-bottom: 8px;
    }

    .adjustment-details button {
        display: block;
        width: 100%;
        margin-right: 0;
        margin-bottom: 10px;
        box-sizing: border-box;
        text-align: center;
        padding: 8px 15px;
    }
    .adjustment-details button:last-child {
        margin-bottom: 0;
    }

    .adjusted-image-actions {
        margin-top: 5px;
        margin-bottom: 10px;
    }

    .adjusted-image-actions button {
        display: block;
        width: calc(100% - 20px);
        margin: 0 auto 10px auto;
        text-align: center;
        padding: 8px 15px;
    }
    .adjusted-image-actions button:last-child {
        margin-bottom: 0;
    }

    .adjusted-image-area p small {
        font-size: 0.8em;
    }

}
</style>
</head>
<body>

<!-- Google Tag Manager -->
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MMQSZM"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MMQSZM');</script>
<!-- End Google Tag Manager -->

<h1>画像比率調整ツール</h1>

<!-- 画像ドラッグ＆ドロップ領域 -->
<div class="drop-area" id="dropArea">
    <p>画像をここにドラッグ＆ドロップ</p>
    <p>または</p>
    <input type="file" id="fileInput" accept="image/*" style="display:none;">
    <button id="browseButton">画像を選択</button>
</div>

<div class="main-content-container">
    <!-- 左カラム：プレビュー群 -->
    <div class="image-preview-container">
        <!-- オリジナル画像プレビュー -->
        <div class="image-preview" id="imagePreview">
            <h2>プレビュー (オリジナル)</h2>
            <img id="previewImage" src="" alt="アップロードされた画像のプレビュー">
        </div>

        <!-- 調整済み画像プレビュー -->
        <div class="adjusted-image-area" id="adjustedImageArea">
            <h2>調整済み画像プレビュー</h2>
            <!-- CanvasはJSでここに挿入されます -->
            <div class="adjusted-image-actions">
                <button id="copyImageButton">画像をコピー</button>
                <button id="downloadImageButton">画像をダウンロード (PNG)</button>
            </div>
            <p><small>※画像をコピー機能は、お使いのブラウザ環境によっては動作しない場合があります（HTTPS接続が必要です）。</small></p>
        </div>
    </div>


    <!-- 右カラム：操作エリア（画像情報、調整オプション） -->
    <div class="controls-area">
        <!-- 画像情報 -->
        <div class="info-panel" id="infoPanel">
            <h2>画像情報 (オリジナル)</h2>
            <div class="info-grid">
                <div class="info-item">
                    <p>幅: <span id="imageWidth">0</span>px <span class="unit-display">(~<span id="imageWidthInch">0.00</span> in)<br> (~<span id="imageWidthCm">0.00</span> cm)</span></p>
                    <p>高さ: <span id="imageHeight">0</span>px <span class="unit-display">(~<span id="imageHeightInch">0.00</span> in)<br> (~<span id="imageHeightCm">0.00</span> cm)</span></p>
                    <p>現在の比率: <span class="current-ratio" id="imageRatio">0:0</span> (<span id="imageRatioDecimal">0.000</span>)</p>
                     <p><small>※インチ/センチ表示は標準的な72DPI換算です。</small></p>
                </div>
                 <!--<div class="info-item">
                    <h3>最も近い一般的な比率</h3>
                    <p id="closestRatio">-</p>
                </div>-->
            </div>
        </div>

        <!-- 一般的な比率への調整オプション -->
        <div class="adjustment-options" id="adjustmentOptions">
             <!-- スケールと余白色コントロール -->
             <div id="scaleControl">
                 <label for="scale">倍率:</label>
                 <input type="number" id="scale" value="1.0" min="0.1" step="0.1"> 倍
             </div>
             <div id="colorPickerControl">
                 <label for="padColor">余白の色:</label>
                 <input type="color" id="padColor" value="#ffffff">
             </div>

            <h2>比率を選択して調整</h2>
            <!-- 比率選択セレクトボックス -->
            <div class="ratio-select-container">
                <label for="ratioSelect">調整したい比率:</label>
                <select id="ratioSelect">
                    <option value="">-- 比率を選択してください --</option>
                    <!-- オプションはJSで追加されます -->
                </select>
            </div>

            <!-- 選択された比率の詳細表示エリア -->
            <div id="selectedRatioDetails">
                <!-- 選択された比率の調整方法（リサイズ/クロップ）がJSで挿入されます -->
            </div>
        </div>
    </div>
</div>


<script>
    // よく使われる比率のリスト
    const commonRatios = [
        { name: '1:1 (正方形)', ratio: 1, description: 'インスタグラムの投稿やプロフィール写真に最適' },
        { name: '4:3', ratio: 4 / 3, description: '従来のテレビやコンピュータ画面の標準比率' },
        { name: '3:2', ratio: 3 / 2, description: '35mmフィルムの比率で多くのDSLRカメラで使用' },
        { name: '16:9 (ワイドスクリーン)', ratio: 16 / 9, description: '現代のテレビやモニター、YouTubeの標準' },
        { name: '21:9 (ウルトラワイド)', ratio: 21 / 9, description: '映画やウルトラワイドモニター用の比率' },
        { name: '9:16 (縦長)', ratio: 9 / 16, description: 'モバイル用の縦長動画（TikTok、Instagram Reels）' },
        { name: '2:3 (縦長)', ratio: 2 / 3, description: '多くの印刷物や本の比率' },
        { name: '5:4', ratio: 5 / 4, description: '大判カメラやある種の印刷物で使用' },
        { name: '黄金比 (約1.618:1)', ratio: (1 + Math.sqrt(5)) / 2, description: '最も美しいとされる比率。アートやデザインに使用' },
        { name: '白銀比 (約√2:1)', ratio: Math.sqrt(2), description: 'A判, B判用紙の比率 (√2:1 または 1:√2)。安定感がある' },
        { name: '青銅比 (約1.839:1)', ratio: 1.8392867552141612, description: 'x^3 - x^2 - x - 1 = 0 の実根。新しい美の比率として注目されることも' }
    ];

    // DOM要素の取得
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const browseButton = document.getElementById('browseButton');
    const imagePreview = document.getElementById('imagePreview');
    const previewImage = document.getElementById('previewImage');
    const infoPanel = document.getElementById('infoPanel');
    const imageWidthSpan = document.getElementById('imageWidth');
    const imageHeightSpan = document.getElementById('imageHeight');
    const imageWidthInchSpan = document.getElementById('imageWidthInch');
    const imageHeightInchSpan = document.getElementById('imageHeightInch');
    const imageWidthCmSpan = document.getElementById('imageWidthCm');
    const imageHeightCmSpan = document.getElementById('imageHeightCm');
    const imageRatioSpan = document.getElementById('imageRatio');
    const imageRatioDecimalSpan = document.getElementById('imageRatioDecimal');
    const closestRatioP = document.getElementById('closestRatio');
    const adjustmentOptionsDiv = document.getElementById('adjustmentOptions');
    const scaleInput = document.getElementById('scale');
    const padColorInput = document.getElementById('padColor');
    const ratioSelect = document.getElementById('ratioSelect'); // 追加
    const selectedRatioDetailsDiv = document.getElementById('selectedRatioDetails'); // 追加
    const adjustedImageAreaDiv = document.getElementById('adjustedImageArea');
    const copyImageButton = document.getElementById('copyImageButton');
    const downloadImageButton = document.getElementById('downloadImageButton');

    // 状態変数
    let currentImage = { dataURL: null, width: 0, height: 0 };
    let currentScale = parseFloat(scaleInput.value);
    let currentPadColor = padColorInput.value;

    const DPI = 72; // 標準的なDPI

    // ヘルパー関数
    function pxToInch(px, dpi = DPI) { return px / dpi; }
    function pxToCm(px, dpi = DPI) { return pxToInch(px, dpi) * 2.54; }
    function gcd(a, b) { if (b === 0) return a; a = Math.abs(a); b = Math.abs(b); return gcd(b, a % b); }
    function simplifyRatio(width, height) {
        if (height === 0) return [width, 0];
        if (width === 0) return [0, height];
        width = Math.abs(width);
        height = Math.abs(height);
        const divisor = gcd(width, height);
        if (divisor === 0) return [width, height];
        return [width / divisor, height / divisor];
    }

    // イベントリスナー設定
    browseButton.addEventListener('click', () => { fileInput.click(); });
    fileInput.addEventListener('change', handleFileSelect);

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });

    function highlight() { dropArea.classList.add('active'); }
    function unhighlight() { dropArea.classList.remove('active'); }

    dropArea.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0 && files[0].type.match('image.*')) {
            handleFiles(files);
        }
    }

    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFiles(files);
        }
        // ファイル選択ダイアログをリセット（同じファイルを選び直せるように）
        e.target.value = '';
    }

    function handleFiles(files) {
        const file = files[0];
        if (!file.type.match('image.*')) {
            alert('画像ファイルを選択してください。');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                currentImage = {
                    dataURL: e.target.result,
                    width: img.naturalWidth,
                    height: img.naturalHeight
                };
                previewImage.src = currentImage.dataURL;
                imagePreview.style.display = 'flex'; // Flexbox表示
                displayImageInfo(currentImage.width, currentImage.height);
                adjustmentOptionsDiv.style.display = 'block'; // 表示
                adjustedImageAreaDiv.style.display = 'none'; // 調整済みプレビューは隠す
                populateRatioSelect(); // セレクトボックスに比率を追加
                 ratioSelect.value = ""; // セレクトボックスを初期状態に戻す
                 selectedRatioDetailsDiv.innerHTML = ''; // 詳細表示をクリア

            };
            img.onerror = function() {
                alert('画像の読み込みに失敗しました。');
                initializeUI(); // UIを初期状態に戻す
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    function displayImageInfo(width, height) {
        if (width === 0 || height === 0) {
            initializeUI(); // 画像が無効ならUIを初期状態に戻す
            return;
        }

        imageWidthSpan.textContent = width;
        imageHeightSpan.textContent = height;
        imageWidthInchSpan.textContent = pxToInch(width).toFixed(2);
        imageHeightInchSpan.textContent = pxToInch(height).toFixed(2);
        imageWidthCmSpan.textContent = pxToCm(width).toFixed(2);
        imageHeightCmSpan.textContent = pxToCm(height).toFixed(2);

        const [ratioWidth, ratioHeight] = simplifyRatio(width, height);
        imageRatioSpan.textContent = `${ratioWidth}:${ratioHeight}`;
        const decimalRatio = width / height;
        imageRatioDecimalSpan.textContent = decimalRatio.toFixed(3);

        // 最も近い比率を計算
        /*let closestDiff = Infinity;
        let closestRatioInfo = null;
        const currentDecimalRatio = width / height;

        for (const ratio of commonRatios) {
            const targetDecimalRatio = ratio.ratio;
            const diffToTarget = Math.abs(currentDecimalRatio / targetDecimalRatio - 1);
            const diffToTargetInv = Math.abs(currentDecimalRatio / (1/targetDecimalRatio) - 1);
            const minDiff = Math.min(diffToTarget, diffToTargetInv);

            if (minDiff < closestDiff) {
                closestDiff = minDiff;
                closestRatioInfo = ratio;
            }
        }
         if (closestRatioInfo) {
            closestRatioP.innerHTML = `<strong>${closestRatioInfo.name}</strong><br><span class="ratio-description">${closestRatioInfo.description}</span>`;
         } else {
             closestRatioP.textContent = '-';
         }*/

        infoPanel.style.display = 'block'; // 情報パネルを表示
    }

    // 比率選択セレクトボックスにオプションを追加
    function populateRatioSelect() {
        ratioSelect.innerHTML = '<option value="">-- 比率を選択してください --</option>'; // 初期オプションをクリア＆追加
         // 比率リストを比率値でソート（任意、見やすさのため）
        const sortedCommonRatios = [...commonRatios].sort((a, b) => a.ratio - b.ratio);

        sortedCommonRatios.forEach(ratioInfo => {
            const option = document.createElement('option');
            option.value = ratioInfo.ratio;
            option.textContent = ratioInfo.name;
            // option.dataset.description = ratioInfo.description; // 説明は選択後に表示
            ratioSelect.appendChild(option);
        });
    }

    // 選択された比率の詳細情報を表示
    function displaySelectedRatioDetails(ratioValue) {
        selectedRatioDetailsDiv.innerHTML = ''; // 詳細エリアをクリア

        if (!ratioValue || !currentImage.dataURL) {
            return; // 比率が選択されていないか、画像が読み込まれていない場合は何もしない
        }

        const ratioInfo = commonRatios.find(r => Math.abs(r.ratio - ratioValue) < 1e-6); // 厳密な一致ではなく微小な差を許容
        if (!ratioInfo) {
            selectedRatioDetailsDiv.innerHTML = '<p>選択された比率の情報が見つかりません。</p>';
            return;
        }

        const originalWidth = currentImage.width;
        const originalHeight = currentImage.height;
        const scale = currentScale;
        const decimalRatio = originalWidth / originalHeight;
        const targetRatio = ratioInfo.ratio;

        // リサイズ（余白追加）の場合の計算
        let targetPadW_1x, targetPadH_1x;
        if (decimalRatio > targetRatio) {
            targetPadW_1x = originalWidth;
            targetPadH_1x = originalWidth / targetRatio;
        } else {
            targetPadH_1x = originalHeight;
            targetPadW_1x = originalHeight * targetRatio;
        }
        const padSizeW_scaled = Math.round(targetPadW_1x * scale);
        const padSizeH_scaled = Math.round(targetPadH_1x * scale);


        // クロップの場合の計算
        let targetCropW_1x, targetCropH_1x;
        if (decimalRatio > targetRatio) {
            targetCropH_1x = originalHeight;
            targetCropW_1x = originalHeight * targetRatio;
        } else {
            targetCropW_1x = originalWidth;
            targetCropH_1x = originalWidth / targetRatio;
        }
        const cropSizeW_scaled = Math.round(targetCropW_1x * scale);
        const cropSizeH_scaled = Math.round(targetCropH_1x * scale);

        // クロップが可能か判定
        const isCropPossible = cropSizeW_scaled > 0 && cropSizeH_scaled > 0 && cropSizeW_scaled <= originalWidth * scale && cropSizeH_scaled <= originalHeight * scale;


        let detailsHTML = `
            <h3>${ratioInfo.name}</h3>
            <p class="ratio-description">${ratioInfo.description}</p>

            <div class="adjustment-details">
                <h4>リサイズ (余白追加)</h4>
                <table>
                    <tr><td>新しいサイズ</td><td>${padSizeW_scaled} × ${padSizeH_scaled}px</td></tr>
                    <tr>
                        <td>単位換算 (~72DPI)</td>
                        <td>
                            <span class="unit-display">~${pxToInch(padSizeW_scaled).toFixed(2)} in × ~${pxToInch(padSizeH_scaled).toFixed(2)} in</span>
                            <span class="unit-display">~${pxToCm(padSizeW_scaled).toFixed(2)} cm × ~${pxToCm(padSizeH_scaled).toFixed(2)} cm</span>
                        </td>
                    </tr>
                </table>
                <button data-ratio-name="${ratioInfo.name}" data-ratio-value="${ratioInfo.ratio}" data-type="pad">調整した画像を生成</button>
            </div>
        `;

        if (isCropPossible) {
            detailsHTML += `
                <div class="adjustment-details">
                    <h4>クロップ</h4>
                     <table>
                        <tr><td>新しいサイズ</td><td>${cropSizeW_scaled} × ${cropSizeH_scaled}px</td></tr>
                         <tr>
                            <td>単位換算 (~72DPI)</td>
                             <td>
                                <span class="unit-display">~${pxToInch(cropSizeW_scaled).toFixed(2)} in × ~${pxToInch(cropSizeH_scaled).toFixed(2)} in</span>
                                <span class="unit-display">~${pxToCm(cropSizeW_scaled).toFixed(2)} cm × ~${pxToCm(cropSizeH_scaled).toFixed(2)} cm</span>
                            </td>
                        </tr>
                    </table>
                    <button data-ratio-name="${ratioInfo.name}" data-ratio-value="${ratioInfo.ratio}" data-type="crop">調整した画像を生成</button>
                </div>
            `;
        }

        selectedRatioDetailsDiv.innerHTML = detailsHTML;
    }


    // 倍率入力時の処理
    scaleInput.addEventListener('input', e => {
        const value = parseFloat(e.target.value);
        if (!isNaN(value) && value > 0) {
            currentScale = value;
            if (currentImage.dataURL) {
                // セレクトボックスで現在選択されている比率があれば、詳細表示を更新
                if (ratioSelect.value !== "") {
                     displaySelectedRatioDetails(parseFloat(ratioSelect.value));
                }

                 // 調整済み画像が表示されていれば、同じ設定で再生成を試みる
                 const currentCanvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
                 if (currentCanvas && currentCanvas.dataset.adjustmentType && currentImage.dataURL) {
                     const ratioValue = parseFloat(currentCanvas.dataset.ratioValue);
                     const ratioName = currentCanvas.dataset.ratioName;
                     const type = currentCanvas.dataset.adjustmentType;
                      // 新しいスケールで再生成
                     const ratioInfoUsed = commonRatios.find(r => Math.abs(r.ratio - ratioValue) < 1e-6);
                     if(ratioInfoUsed) {
                         generateAdjustedImage(currentImage.dataURL, currentImage.width, currentImage.height, ratioInfoUsed, type, currentScale, currentPadColor)
                             .catch(error => console.error("Auto-regenerate failed on scale change:", error));
                     }
                 }
            }
        }
    });

    // 余白色変更時の処理
    padColorInput.addEventListener('input', e => {
        currentPadColor = e.target.value;
        // 余白（pad）タイプの調整済み画像が表示されている場合、色だけ更新（Canvasを再描画）
        const currentCanvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
        if (currentCanvas && currentCanvas.dataset.adjustmentType === 'pad' && currentImage.dataURL) {
            const ratioValue = parseFloat(currentCanvas.dataset.ratioValue);
            const ratioName = currentCanvas.dataset.ratioName;
            const scaleUsedForCanvas = parseFloat(currentCanvas.dataset.scale); // Canvas生成時のスケールを使用

            const ratioInfoUsed = commonRatios.find(r => Math.abs(r.ratio - ratioValue) < 1e-6);
            if(ratioInfoUsed) {
                generateAdjustedImage(currentImage.dataURL, currentImage.width, currentImage.height, ratioInfoUsed, 'pad', scaleUsedForCanvas, currentPadColor)
                    .catch(error => console.error("Auto-regenerate failed on color change:", error));
            }
        }
    });

    // 比率選択セレクトボックス変更時の処理
    ratioSelect.addEventListener('change', e => {
        const selectedRatioValue = parseFloat(e.target.value);
        displaySelectedRatioDetails(selectedRatioValue);
    });


    // 調整ボタンクリック時の処理 (イベント委譲)
    selectedRatioDetailsDiv.addEventListener('click', async e => {
        const button = e.target.closest('button');
        if (!button || !button.dataset.type) return;

        const ratioName = button.dataset.ratioName;
        const ratioValue = parseFloat(button.dataset.ratioValue);
        const type = button.dataset.type;

        if (!currentImage.dataURL) {
            alert('先に画像をアップロードしてください。');
            return;
        }
        if (isNaN(currentScale) || currentScale <= 0) {
            alert('倍率を正の値にしてください。');
            return;
        }

        // 生成中のフィードバック
        button.disabled = true;
        const originalButtonText = button.textContent;
        button.textContent = '生成中...';

        try {
             const ratioInfo = commonRatios.find(r => Math.abs(r.ratio - ratioValue) < 1e-6);
             if (!ratioInfo) throw new Error('選択された比率の情報が見つかりません。');

            // 画像生成処理の呼び出し
            await generateAdjustedImage(currentImage.dataURL, currentImage.width, currentImage.height, ratioInfo, type, currentScale, currentPadColor);
        } catch (error) {
            console.error("Error generating image:", error);
            alert("画像の生成中にエラーが発生しました。\n" + error.message);
             // エラー時もボタンテキストを戻す
             if (button.textContent === '生成中...') {
                 button.textContent = originalButtonText;
             }
        } finally {
            // 生成中のフィードバックを解除
            button.disabled = false;
            // 成功時はテキストを変えない（生成済みを維持）
        }
    });

    // 調整済み画像を生成する関数 (変更なし)
    async function generateAdjustedImage(imageDataURL, originalWidth, originalHeight, ratioInfo, type, scale, padColor) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = function() {
                const originalRatio = originalWidth / originalHeight;
                const targetRatio = ratioInfo.ratio;

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');

                let canvasW, canvasH;
                let cropX = 0, cropY = 0, cropW = originalWidth, cropH = originalHeight;
                let drawX = 0, drawY = 0, drawW, drawH;

                if (type === 'pad') {
                    let targetCanvasW_1x, targetCanvasH_1x;
                    if (originalRatio > targetRatio) {
                        targetCanvasW_1x = originalWidth;
                        targetCanvasH_1x = originalWidth / targetRatio;
                    } else {
                        targetCanvasH_1x = originalHeight;
                        targetCanvasW_1x = originalHeight * targetRatio;
                    }

                    canvasW = Math.round(targetCanvasW_1x * scale);
                    canvasH = Math.round(targetCanvasH_1x * scale);

                    canvas.width = canvasW;
                    canvas.height = canvasH;

                    context.fillStyle = padColor;
                    context.fillRect(0, 0, canvas.width, canvas.height);

                    drawW = originalWidth * scale;
                    drawH = originalHeight * scale;
                    drawX = (canvas.width - drawW) / 2;
                    drawY = (canvas.height - drawH) / 2;

                    context.drawImage(img, 0, 0, originalWidth, originalHeight, drawX, drawY, drawW, drawH);

                } else if (type === 'crop') {
                    let targetCropW_1x, targetCropH_1x;
                    if (originalRatio > targetRatio) {
                        targetCropH_1x = originalHeight;
                        targetCropW_1x = originalHeight * targetRatio;
                    } else {
                        targetCropW_1x = originalWidth;
                        targetCropH_1x = originalWidth / targetRatio;
                    }

                    cropW = targetCropW_1x;
                    cropH = targetCropH_1x;
                    cropX = (originalWidth - cropW) / 2;
                    cropY = (originalHeight - cropH) / 2;

                    canvasW = Math.round(cropW * scale);
                    canvasH = Math.round(cropH * scale);

                     if (cropW <= 0 || cropH <= 0 || canvasW <= 0 || canvasH <= 0) {
                          reject(new Error("クロップサイズが無効です。"));
                          return;
                     }

                    canvas.width = canvasW;
                    canvas.height = canvasH;

                    drawX = 0;
                    drawY = 0;
                    drawW = canvas.width;
                    drawH = canvas.height;

                    context.drawImage(img, cropX, cropY, cropW, cropH, drawX, drawY, drawW, drawH);

                } else {
                    reject(new Error('Unknown adjustment type: ' + type));
                    return;
                }

                canvas.dataset.adjustmentType = type;
                canvas.dataset.ratioName = ratioInfo.name;
                canvas.dataset.ratioValue = ratioInfo.ratio;
                canvas.dataset.scale = scale;
                canvas.dataset.padColor = padColor; // padの場合のみ有効

                displayAdjustedImage(canvas);
                resolve(canvas);
            };
            img.onerror = reject;
            img.src = imageDataURL;
        });
    }

    // 調整済み画像を表示する関数
    function displayAdjustedImage(canvas) {
        // 以前のCanvasがあれば削除
        const oldCanvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
        if (oldCanvas) {
            adjustedImageAreaDiv.removeChild(oldCanvas);
        }

        canvas.id = 'adjustedCanvas';
        // アクションボタンの上にCanvasを挿入
        adjustedImageAreaDiv.insertBefore(canvas, adjustedImageAreaDiv.querySelector('.adjusted-image-actions'));
        adjustedImageAreaDiv.style.display = 'block'; // プレビューエリアを表示

        // 調整済み画像エリアまでスクロール
        // adjustedImageAreaDiv.scrollIntoView({ behavior: 'smooth', block: 'start' }); // 不要ならコメントアウト
    }

    // 画像コピーボタンの処理 (変更なし)
    copyImageButton.addEventListener('click', async () => {
        const canvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
        if (!canvas) {
            alert('コピーする画像がありません。画像を生成してください。');
            return;
        }

        if (typeof ClipboardItem !== 'function' || !navigator.clipboard || !navigator.clipboard.write) {
            alert('お使いのブラウザでは画像のコピー機能がサポートされていないか、安全な接続（HTTPS）が必要です。ダウンロード機能をご利用ください。');
            return;
        }

        try {
            canvas.toBlob(async (blob) => {
                if (!blob) {
                    alert('画像のデータ取得に失敗しました。コピーできませんでした。');
                    return;
                }
                try {
                    const item = new ClipboardItem({ "image/png": blob });
                    await navigator.clipboard.write([item]);
                    alert('画像をクリップボードにコピーしました！');
                } catch (err) {
                    console.error('Failed to copy image using ClipboardItem:', err);
                    alert('画像のコピーに失敗しました。\n(注: この機能はHTTPS接続またはローカル環境でのみ利用可能です。)');
                }
            }, 'image/png');
        } catch (err) {
            console.error('Error creating blob for copy:', err);
             alert('画像のデータ取得に失敗しました。コピーできませんでした。');
        }
    });

    // 画像ダウンロードボタンの処理 (変更なし)
    downloadImageButton.addEventListener('click', () => {
        const canvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
        if (!canvas) {
            alert('ダウンロードする画像がありません。画像を生成してください。');
            return;
        }

        canvas.toBlob((blob) => {
            if (!blob) {
                alert('画像のデータ取得に失敗しました。ダウンロードできませんでした。');
                return;
            }

            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;

            // ファイル名の生成
            let filename = 'adjusted_image';
            const currentCanvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
            if (currentCanvas && currentCanvas.dataset.ratioName && currentCanvas.dataset.adjustmentType && currentCanvas.dataset.scale) {
                const ratio = currentCanvas.dataset.ratioName.replace(/[^\w\s-]/g, '').trim().replace(/\s+/g, '_');
                const type = currentCanvas.dataset.adjustmentType;
                const scaleValue = parseFloat(currentCanvas.dataset.scale) || 1.0;
                const scaleStr = scaleValue.toFixed(1).replace('.', 'p');

                filename = `${ratio}_${type}_x${scaleStr}`;
            }

            a.download = `${filename}_${Date.now()}.png`;

            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            URL.revokeObjectURL(url);
        }, 'image/png');
    });

    // UIを初期状態に戻す関数
    function initializeUI() {
        imagePreview.style.display = 'none';
        infoPanel.style.display = 'none';
        adjustmentOptionsDiv.style.display = 'none';
        adjustedImageAreaDiv.style.display = 'none';

        // 表示情報をクリア
        previewImage.src = '';
        currentImage = { dataURL: null, width: 0, height: 0 };
        closestRatioP.textContent = '-';

        imageWidthSpan.textContent = '0';
        imageHeightSpan.textContent = '0';
        imageWidthInchSpan.textContent = '0.00';
        imageHeightInchSpan.textContent = '0.00';
        imageWidthCmSpan.textContent = '0.00';
        imageHeightCmSpan.textContent = '0.00';
        imageRatioSpan.textContent = '0:0';
        imageRatioDecimalSpan.textContent = '0.000';

        // 倍率と余白色を初期値に戻す
        currentScale = 1.0;
        scaleInput.value = currentScale.toFixed(1);
        currentPadColor = '#ffffff';
        padColorInput.value = currentPadColor;

        // 比率選択と詳細表示エリアをクリア
        populateRatioSelect(); // セレクトボックスを初期化オプションで埋める
        ratioSelect.value = ""; // セレクトボックスを選択なし状態に
        selectedRatioDetailsDiv.innerHTML = ''; // 詳細表示をクリア

        // 調整済み画像Canvasを削除 (もしあれば)
        const oldCanvas = adjustedImageAreaDiv.querySelector('#adjustedCanvas');
        if (oldCanvas) {
            adjustedImageAreaDiv.removeChild(oldCanvas);
        }
    }

    // ページ読み込み時にUIを初期化
    document.addEventListener('DOMContentLoaded', initializeUI);

</script>

</body>
</html>
